name: Docker Versioned Build and Push

on:
  push:
    tags:
      - 'v*'

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: 🔍 DEBUG: Check if secrets exist
      run: |
        if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
          echo " DOCKERHUB_USERNAME is missing!"
          exit 1
        else
          echo " DOCKERHUB_USERNAME exists."
        fi

        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo " DOCKERHUB_TOKEN is missing!"
          exit 1
        else
          echo " DOCKERHUB_TOKEN exists."
        fi

    - name: Log in to Docker Hub
      uses: docker/login-action@v3.1.0
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

    - name: Build and Push Backend
      run: |
        docker build -t bhornpat/dockerized-notepad-backend:latest -t bhornpat/dockerized-notepad-backend:${{ steps.get_version.outputs.version }} ./backend
        docker push bhornpat/dockerized-notepad-backend:latest
        docker push bhornpat/dockerized-notepad-backend:${{ steps.get_version.outputs.version }}

    - name: Build and Push Frontend
      run: |
        docker build -t bhornpat/dockerized-notepad-frontend:latest -t bhornpat/dockerized-notepad-frontend:${{ steps.get_version.outputs.version }} ./frontend
        docker push bhornpat/dockerized-notepad-frontend:latest
        docker push bhornpat/dockerized-notepad-frontend:${{ steps.get_version.outputs.version }}

